name: Deploy to Freemius

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # Matches version tags like 1.0.2, 2.1.0

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Freemius

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create plugin zip
        run: |
          zip -r smart-cycle-discounts.zip . \
            -x "*.git*" \
            -x "*.github*" \
            -x ".wordpress-org/*" \
            -x "node_modules/*" \
            -x "tests/*" \
            -x "bin/*" \
            -x "*.md" \
            -x "*.sh" \
            -x "*.py" \
            -x "composer.json" \
            -x "composer.lock" \
            -x "phpunit*.xml" \
            -x "package.json" \
            -x "package-lock.json" \
            -x "vendor/bin/*" \
            -x "vendor/composer/*" \
            -x "vendor/dealerdirect/*" \
            -x "vendor/doctrine/*" \
            -x "vendor/myclabs/*" \
            -x "vendor/nikic/*" \
            -x "vendor/phar-io/*" \
            -x "vendor/phpcsstandards/*" \
            -x "vendor/phpunit/*" \
            -x "vendor/sebastian/*" \
            -x "vendor/squizlabs/*" \
            -x "vendor/theseer/*" \
            -x "vendor/wp-coding-standards/*" \
            -x "vendor/yoast/*" \
            -x "vendor/autoload.php" \
            -x "Webstepper.io/*"

      - name: Deploy to Freemius
        uses: buttonizer/freemius-deploy@v1.0.2
        env:
          DEV_ID: ${{ secrets.FREEMIUS_DEV_ID }}
          PLUGIN_ID: ${{ secrets.FREEMIUS_PLUGIN_ID }}
          PLUGIN_SLUG: smart-cycle-discounts
          PUBLIC_KEY: ${{ secrets.FREEMIUS_PUBLIC_KEY }}
          SECRET_KEY: ${{ secrets.FREEMIUS_SECRET_KEY }}
        with:
          file_name: smart-cycle-discounts.zip
          version: ${{ steps.version.outputs.VERSION }}
